\chapter{Results}
This chapter presents the developed methodology used in the compilation of the dataset. 
The results from the experiments conducted based on the setup and configuration presented in Section \ref{sec:hyperparam_tuning}. Finally, each model is evaluated on unseen portion of the dataset presented in the first region.

Several candidate satellites were studied before arriving at the combination of datasets presented here. Spatiotemporal consistency and resolution was given high priority. 
The variable cloud mask is provided by many satellites, bringing valuable information in itself, but also for the retrieval of other variables restricted to cloud free conditions, such as humidity. The satellite product chosen for this project is the \acrfull{msg}. This satellite is in geostationary orbit, and has an exceptional temporal resolution, scans every 15min. Knowing that the average lifetime of a cloud is 60min or less, it seems like a reasonable choice (\cite{lohmann2016}, pp. 19). The finished dataset, described in detail below, is named \acrfull{ecc}.

\section{Dataset - European Cloud Cover }
This section presents the developed algorithms necessary for the compilation of the dataset \acrfull{ecc}. It is pieced together from two sources, ERA5 reanalysis and METeosat second generation cloud mask. % This requires the regridding of one of them.

\acrshort{ecc} comprises of five variables collected from two sources; ERA5 and EUMETSAT. The resolution available in ERA5 was preserved, while remapping the cloud mask to cloud fractions. The final product consist of the variables temperature, pressure, cloud fraction, specific humidity and relative humidity, available hourly data on a $0.25^o$ uniform grid resolution in the period from April 2004 to December 2018. Cloud fractional cover (\acrshort{cfc}) is produced from area weighting cloud masks. These computations are described in \ref{sec:remapping}. The remaining variables are on their original format as provided by \acrfull{ecmwf}. A summary of the original sources of the dataset is given in table \ref{tab:dataset_summary}. More details on ERA5 is available in Section \ref{sec:era5} and see section \ref{sec:EUMETSAT_cloud_mask} for more information about cloud mask. 
\input{Chapter2_Theory/tables/table_transposed.tex}

\subsection{Domain}
For this project the geographical domain has been restricted to latitude, $\theta \in[30,50]$ and longitude $\phi \in [-15, 25]$. The resulting dimensions of the grid become $81\times161$ pixels. Figure \ref{fig:map} shows the region of Europe included in this dataset, covering the central Europe and north Africa.

\begin{figure}[h]
    \centering
    \includegraphics[scale = 1.0]{python_figs/Domain.png}
    \caption[Map over domain.]{Map showing the domain in the projection available in ECC. The region covers central Europe and north Africa.}
    \label{fig:map}
\end{figure}

\begin{figure}
    \centering
    \includegraphics{Chapter4_Results/figurs/regridded_raw_satelite_image_to_make_sure_its_correcxt_area.png}
    \caption{Regridded the raw data including land sea pixels where there is no presence of clouds. A visual test of the regridded scheme, especially useful since different formats provide different rotation of the scan.}
    \label{fig:correct_area}
\end{figure}

\subsection{Physical basis of variable decision} \label{sec:ecc}
The overall goal is to investigate whether basic meteorological variables such as temperature, pressure and humidity are sufficient for prediction of cloud fractional cover with a reasonable accuracy. As discussed in Section \ref{sec:cloud_in_climate_system}, cloud dynamics is far more complicated than what can be describes by these variables. 

This is a \textit{proof of concept study} aimed to demonstrate the feasibility of using \acrshort{ai} to parametize \acrshort{cfc}. Employing data driven learning to represent cloud physics and dynamics in its full complexity requires measurements from technologies not yet invented. If they did exist, the computational cost would be enormous, and even then there would be no guarantee that the model performance would be state-of-the-art.
%Not feasible in the foreseeable future to incorporate all the effects of micro-physics at a sufficient accuracy. 

Macrophysics properties describes the cloud as a whole. Examples of such properties are base height, top height, thickness, fractional cover and regime also known as type. Microphysical processes are all mechanisms involving the particles making up a cloud. Examples of these variable are cloud condensation nuclei and droplet number concentrations (\cite{Grabowski2019ModelingBetter}). 

Precipitation formation and cloud optical thickness is affected by changes on a microphysical level. However, they are undeniably closely related to the macrophysical properties of the cloud. Imagine precipitation without a cloud fractional cover? 

Focusing on the macro-physical aspect of clouds its is reasonable to chose large-scale variables, for which reliable estimates are available from using reanalyse and other climate model, thereby ensuring that it is possible to build usable application of this in the future. 

The variables have been chosen because they are reliable (temperature and pressure) and/or cause the are essential in cloud formation (humidities). Other information may be present implicitly in these variables, being either surface variables or collected from the highest pressure level, the level closest to the surface. All variables are produced by ERA5. This section will give a brief introduction to their role in cloud formation. 

From the weather maps on the news, low and high pressure systems might be familiar terms. Low pressure systems are often associated with precipitation, while high pressure systems are associated with nice weather. Due to its spherical geometry the earth is not equally heated. Warmer air rises, this generates a low pressure at the surface. As the air rises the temperature decreases. Based on Equation \eqref{eq:clausius_clapeyron} its shown that, colder air can retain less vapour, enhancing the rate at which saturation is achieved. Under supersaturated conditions some of this vapour condenses, generating cloud water, forming a cloud, and occasionally precipitation. Summer is often associated with these convective motions generating cumulus type clouds. In presence of water at the surface, evaporation rates are also higher in a warmer climate. 

In areas of lower pressure the surrounding air will flow toward the low pressure centre in order to offset the pressure difference. Induced by Earths rotation the Coriolis effect force winds of low pressure system swirl counterclockwise north of the equator and clockwise south of the equator, causing an accumulation of air in the centre of low pressure system. Pushing it to higher altitudes in the atmosphere. A high pressure system exhibit the exact opposite behaviour, its swirls in the reverse direction, and the air flows from the centre. Diverging air masses cause sinking motions of parcels from higher in the atmosphere fill the space.
% air from higher in the atmosphere to sink and fill the space left.
% \textit{Air from higher in the atmosphere sinks down to fill the space left as air moves outward.} 
Winds transports the substances suspended in air, such as pollution and humidity.

The dataset includes both relative and specific humidity. Relative humidity is a measure of how much vapour the air contains, relative to much it can hold at that temperature. It is unitless, and ranges from 0 to 1. Conditions where relative humidity exceeds one are called supersaturated. Specific humidity is the ratio between mass of vapour and mass of air, with unit of $kg kg^{-1}$ (\cite{lohmann2016}, pp. 53-54). Whether the relative or specific humidity is the better predictor is not clear a priori. The data is gathered from the model level closest to the surface, at an altitude of 1000hPa (\cite{lohmann2016}, pp. 81-84). 

\subsection{Regridding scheme} \label{sec:remapping}
\input{Chapter4_Results/figurs/spherical_coord}
Computing cloud fractions based on cloud mask requires a regridding scheme, common approaches are mean, nearest neighbour or area weighting. For this particular task, since the pixels are of uneven size, the area weighted seemed most appropriate. This section will provided a step-by-step description of the necessary preprocessing done for the compilation of \acrshort{ecc}, transforming clouds masks provided in \textit{space-view} to cloud fractions on a uniform grid. \acrshort{eumetsat} doesn't provide suitable software to tackle this particular task (personal communication EUMETSAT staff). Building the dataset requires the implementations of this software.

%In order to build the dataset to cover our needs for this application, the area weighting and regridding to ERA5 grid was implemented in Python.
%\textit{The regridding functionality was implemented in Python and is publicly available though the project GitHub. Running the code for all year takes a while on a regular computer. Each time step is stored in individual grib-files. One netCDF-file is stored for its coordinate-information. Its done like this because of storage limitations. One netCDF-file take up roughly 1GB of memory. }
%\textbf{Write summary based on this list to introduce section.}

%\begin{enumerate}
%    \item Utlede ligningene for areal
%    \item Area of a square in spherical coordinates
%    \item Estimating the changes in latitude and longitude. Based on information about the centre of the pixels. 
%    \item Contributions from boundaries and corners. 
%    \item Validating the algorithm against cdo compute areas and the focusing on the artefact. Making short videos of 500 frames to look at the evolution of cloud cover, to double check that it looks reasonable. 
%    \item Cause of many errors, the data is flipped depending on the file-format it is provided in shuffled/reversed (opp ned, bak fram). Similar shape of distribution of cloud cover as other satelite, usnnhetstegn mens skyfracsjon er en stor funksjon av 
%    item \textbf{Obs Obs - gridtype space view}
%    \item Has anyone managed to handle this kind of data? Obviously the space view perspective grid is natural choice for products derived from geostationary platforms and thus standard in EUMETSAT. 
%    \item Bytt curvelinear til space view.
%    \item Latitude (degrees north), Longitude degrees east.
%\end{enumerate}

Implementing this algorithm is twofold, first detection algorithms determining the contributing pixel to the particular cells in the other coordinate system. Secondly,  deriving the equation necessary for computing the area weighting. 

%The satellite retrievals are provided in a \textit{space-view} grid. 
Pixel-areas are computed using spherical coordinates. Figure \ref{fig:spherical_coords} shows how a square looks projected on to a sphere. Deriving the equation for computing the area of an square in spherical coordinates, requires integrating over changes in latitude, $\theta$ and longitude, $\phi$. The general expression for the area of a square in spherical coordinates, is given by the following integral. 
\begin{equation} \label{eq:sphere_integral}
    A = -R^2\int_{ \theta - \delta \theta }^{\theta + \delta \theta} \int_{ \phi - \delta \phi }^{\phi + \delta \phi} cos\left( \theta' \right) d\phi' d\theta'
\end{equation}
This can be rewriting into, \textbf{needs indices $(i, j)$ ..?}
\begin{equation} \label{eq:sphere_finish}
    A \left( \theta, \phi, \delta \theta, \delta \phi   \right)= 2R^2 \left( sin\left( \theta + \delta \theta  \right) - sin\left(  \theta - \delta \theta  \right) \right) \delta \phi
\end{equation}
In relation to Figure \ref{fig:spherical_coords} $d \theta = 2 \delta \theta$, $d \phi = 2 \delta \phi$. Highlighting the parts necessary to compute an area, here $R=6378km$ denotes the distance to earth centre, $\theta$ the latitude and $\phi$ the longitude. Equation \ref{eq:sphere_finish} is implemented scaled by $R$ to be consistent with CDO code used in testing. 

% Estimating the extent of the cell.
The coordinate information is provided as the latitude, $\theta$ (degrees north) and longitude, $\phi$ (degrees east) of the centre of the pixel. The area computation requires information about the extent of the cell, which requires some simplifications. The changes in longitude (latitude) at a certain pixel are estimated by the average distance to neighbouring points in the relevant directions. Approximation of $d\phi$ and $d\theta$ have been done based on the two-dimensional fields of latitude and longitude values according to the below equations \eqref{eq:app_lon} and  \eqref{eq:app_lat}. Let the horizontal extent of a pixel $(i,j)$ be determined by the the averaged distance between the longitude of neighbouring pixels, see Equation \eqref{eq:app_lon}. The same principles applies in the latitudinal direction, this version is shown in Equation \ref{eq:app_lat}.
% Illustrates how neighbouring pixels, of same extent, appear in spherical coordinates. The area decreases poleward. 
% The below approach underestimates the extent a bit? Jeg tror ikke det .. 

\input{Chapter4_Results/figurs/estimating_changes_in_longitude}
The cloud mask pixels are smallest at the nadir point, increasing in all other directions. Figure \ref{fig:estimate_dlon} shows an example of three neighbouring pixels where the apparent pixel size increases going eastward. This results in different distances from the centre to the right and left neighbour, to take advantage of the analytical expression derived in Equation \ref{fig:correct_area}, the extent is approximated by taking the average of the right and left distances. From Figure \ref{fig:estimate_dlon} it becomes evident that the squares resembles trapezium. As far as the author know, it doesn't exist a solution to a area of a trapezium in spherical coordinates, and its not clear if approximating this using using another numerical method.
%Since changes in degrees varies linearly this should not affect the extent of the cell. More than the error already present in the data. Det forklarer bare hvorfor buelengde ikke er nødvendig.
\begin{equation} \label{eq:app_lon}
    \delta \phi_{i,j} = \left| \frac{\phi_{i+1,j} - \phi_{i-1, j}}{4} \right|
\end{equation}
\begin{equation} \label{eq:app_lat}
    \delta \theta_{i,j} = \left| \frac{\theta_{i,j+1} - \theta_{i, j-1}}{4} \right|
\end{equation}

%\textbf{Present this as something that would be a minor correction.}
%A minor improvement, would be to derive the areas of trapezium in spherical coordinate, however this requires additional dependencies of 
%Failed to derive equations for trapezoidal shapes in spherical coordinate, therefore it never made sense to keep a different left, right, up and down extent. 

% Detecting which pixels that contribute to a cell.
Computing the area weighted average of cloud masks requires detecting the grid$_{\text{MGS}}$ contributing to the grid$_{\text{ERA5}}$ cell, and computing their area. The pixels are divided into five categories; \textit{centre}, \textit{left}, \textit{right}, \textit{up} and \textit{down boundary}. 

Let the subscripts denote the dataset pertaining to a particular grid. Grid$_{\text{MSG}}$ refers to the space-view grid of the \acrlong{msg} and grid$_{\text{ECC}}$ refers to the uniform grid originating from ERA5. It is worth noting that the grid$_{\text{ECC}}$ would be the same as grid$_{\text{ERA5}}$.
\begin{figure}
    \centering
    \includegraphics[scale = 0.6]{Chapter4_Results/figurs/remapping-pixels.JPG}
    \caption{Remapping one cell, studying the number of pixels contributing to a cell. Want to remove this figure, by adding what is shows to \ref{fig:estimate_dlon} ...  Not really sure how pixels contributing to a cell is detected is of any importance.} 
    \label{fig:pixels_contributing_to_cell.}
\end{figure}

\begin{equation} \label{eq:tot_area}
    A = \sum_{i=0}^{N} a_i
\end{equation}

\begin{equation} \label{eq:area_weighting}
    CF_{ECC} = \frac{1}{A} \sum_{i=0}^{N} a_i m_i
\end{equation}

One can easily prove that if all the mask $m_i = 1$ the cloud fraction, $CF_{ECC}=1$. This would not be true if the total area $A$, was determine by the extent of ECC/ERA5 cell. This explains why the overlap of neighbouring cell (see Figure \ref{fig:pixels_contributing_to_cell}) is not a cause for concern. The cloud fractions will not give unphysical values. The only affect worth mentioning is that some cloud mask, located at boundary pixels, contribute marginally more to the fraction than they should, but is in argued here that this is of little importance in the big picture.
% For the boundary categories we only include the contribution from within the cell. This is not actually a strict condition, including the entire area would still keep the fraction within its normal bounds of 0 and 1. However the boundary pixels would have a larger effect on the mean cloud cover since they contribute to several pixels. The footprint size effect on the distribution of cloud cover. For a large pixel size, and less contributing pixels we expect a higher number of grid-cells with close to 0 or 1 cloud amount. Since it alter the number of components you compute the average from.

% The cells in grid$_{\text{MGS}}$ contributing to a particular cell in grid$_{\text{ERA5}i,j}$ is fixed. In order to save computations on areas and detecting contribution pixels these are saved to \acrshort{json}-files. Made available in the the GitHub repository for supplementary material \href{https://github.com/hannasv/MS-suppl}{https://github.com/hannasv/MS-suppl}.

% Since the grid is constant, this is only done once and their indices and computed areas are stored in  Java Script Object Notification, json-files in the GitHub repository for supplementary material.

The cloud masks are provided from EUMETSAT in multiple formats. The \acrshort{grib}-format takes up less disk space. However this format doesn't provide coordinates for grid types such as space view. This information is available in \acrshort{netcdf}-format and is made available for the reader via the supplementary folder. All satellite images are provided using the same grid (personal correspondence with EUMETSAT staff). 

\subsection{Missing Data} \label{sec:missing_values}
As always when working with observations. The sensors fail to collect  measurements and data is missing. This can be either individual pixels or entire disks. Since the individual pixels are remapped to fractions by using the area weighted mean, NaN's don't appear too be an issue. When the entire disks are missing, the closest time step available within the previous and trailing 45 minutes are chosen. Gaps that not possible to fill in this way are documented in \textbf{X}. Manually generated datasets are prone to human error. The extra documentation is to ensure the user of what data is included and what is not. The missing values was double checked, but there might still be some data available online that is not included, however this amount should be small. Figure \ref{fig:heatmap_missing_values} show how many hours, that is missing from each of the month in the relevant time period. 

In some cases the data has been destroyed prior to archiving, and can never be recovered. The EUMETSAT staff has been made aware of this problem. The requested data has entered infinity loop without being detected by EUMETSAT along with max pending request restrictions (20), this has slowed things down in addition to create gaps in the data. One request can contain ca. 3.5 months of hourly data. After downloading the data the author had detect missing times and manually choose the closest time step available within the previous and trailing 45 minutes are chosen. Based on this experience the author would recommend that the the GUI or API's available for downloading to be taken into account when choosing a dataset.\ref{tab:dataset_summary}

As mentioned in Section \ref{sec:meteosat}, METEOSAT provide a two satellite system, occasionally both standby and the operational scan at the same time. To reduce the perturbations due to parallax of cloud, given a choice the operational satellite is chosen. In cases over technical failures, the standby scan is used, the scans are done from a different nominal position. The coordinate systems are the same, the standby scan is rectified to the position of the operational satellite before the data is provided. 
Before being rectified to the position of the position of the operational satellite. This introduces some complications related to the parallax. This becomes evident in comparison of simultaneous measurements for the operation and the standby METeosat satellites. \textbf{Lage denne figuren?}


\begin{figure}
    \centering
    \includegraphics[scale = 1.0]{python_figs/heatmap_missing_values.pdf}
    \caption[Heatmap showing missing hours for all months or years.]{Heatmap displaying missing hours separated in month and years.}
    \label{fig:heatmap_missing_values}
\end{figure}



\subsection{ARTEFACT and LAND, SEA and Coastline masks} \label{sec:artefact}
The land sea masks are regridded from the HTAP-masks provided by \acrfull{metno}.  In its original format the HTAP masks have a $0.1^o$ resolution and global coverage, not including the polar regions. These are re-gridded to a suitable resolution of $0.25^o$ using functionality available in PyAEROCOM (\href{https://pyaerocom.met.no/}{https://pyaerocom.met.no/}). A python toolbox developed within the \acrfull{aerocom} project, storing only the domain relevant, available in the project supplementary repository. 

\textbf{TODO:} Running the artefact filters to compute how many times this occurs. Make histogram.

Filters available \textit{land}, \textit{sea}, \textit{coastline} and \textit{artefact}. The coastline is defined to be all pixels that are not 100\% either land or sea. For land pixels, coastline pixels exceeding a 50\% threshold are included, the other pixels are regarded at the sea, argue that this is acceptable since this pixels at a level of at least 50\% most like sufficiently affected by maritime conditions that it is reasonable to classify them as sea pixels.

Defining the artefact according to equation, 
\begin{equation} \label{eq:artefact}
    \theta + \frac{1}{3}\phi < 40
\end{equation}
Figure \ref{fig:filter_artefact} show the artefact detecting filter. To keep memory-requirements to a minimum only the parts of the filters relevant domain is stored in the supplementary material for this project.

\begin{figure}
    \centering
    \includegraphics{python_figs/example_artefact.pdf}
    \caption[Artefact in European Cloud Cover dataset.]{Snapshop of artefact that is present in the dataset, ECC. The frequency of occurrence is currently unknown. \textbf{Plan to use the filter on every hour, storing the signal and plotting it in a histogram.}}
    \label{fig:example_artefact}
\end{figure}

\begin{figure}
    \centering
    \includegraphics{python_figs/signal_artefact.png}
    \caption{Occurence of artefact, keep in mind that is not made any effort to distinguish this from when the entire area has cloud cover, this could be done by the ratio of artefact signal to land or something else. }
    \label{fig:signal_artefact}
\end{figure}

\begin{figure}
    \centering
    \includegraphics{python_figs/filters.pdf}
    \caption{Figure shows all filters, in white, available in the python package ``sciclouds''.}
    \label{fig:filters_subplot}
\end{figure}

% Different approaches for detecting the artefact, separating the land, sea and coastline pixels. Filters to remove artefact in future. Can also use this compute statistics over land and ocean. Add land sea mask as subplot. 
Leaving the artefact in the data, its a project in itself to remove this without doing to much damage to the parts that are actually clouds that also produce a signal.

\subsection{Climatological Statistics}
Figure \ref{fig:monthly_mean_ts_vars} shows the spatially averaged monthly mean values for all values. Seasonal effects and differences between land and ocean is evident among all variables.

\begin{figure}[ht]
    \centering
    \includegraphics{python_figs/monthly_means.pdf}
    \caption{Spatially averaged monthly values. Filters are applied for land and sea.}
    \label{fig:monthly_mean_ts_vars}
\end{figure}

Figure \ref{fig:random_week} shows the spatially averaged time series for the first week of August in 2012. It is ment to illustrate the relative strength of the signal feed to the input sequence. As a reference, the signal over land and ocean is provided. All variables display diurnal variations.

\begin{figure}[ht]
    \centering
    \includegraphics{python_figs/spatially_averaged_one_week_from_2012-08-01.pdf}
    \caption{Spatially averaged time series, the filters are applied for land and sea.}
    \label{fig:random_week}
\end{figure}

Figure % \ref{fig:temporally_averaged_data} 
shows the temporally averaged time series for all variables in the dataset. The topography is a clear factor, comparing this contour plot to Figure \ref{fig:map} the patterns are very similar. 



% Finished regriddidng files.
\subsection{Summarise the dataset ECC.}
Fractional cloud cover is computed from the cloud mask product retrieved by the second generations METeosat satellites. You can read more about this data in section \ref{sec:meteosat}. For simplicity we will refer to this dataset as European Cloud Cover Dataset, ECC from now on. The visual comparison between raw satellite images and cloud amount seem to agree. The cloud fractional distribution also retain the same shape as ERA5 and MODIS 6.1 Terra in the period from 2004 to 2018. \textbf{kilde?}
\input{Chapter4_Results/figurs/estimating_changes_lat_lon} % Move

%\subsection{Licences and Downloading Data} \label{sec:downloading_data}
%Scripts for downloading the ERA5 data used in this thesis is available in the project GitHub on \href{https://github.com/hannasv/MS/tree/metos/downloading{\_}RA}{https://github.com/hannasv/MS/tree/metos/downloading{\_}RA}. However you will need to create a CDS-user. Follow the instructions on ECMWF homepages on \textit{how to download ERA5}. There are no scripts available for downloading METEOSAT data this is done using satellite retrievals at EUMETSATs Earth Observation Portal. Its freely available in hourly resolution. Scientist can apply for increased resolution up to 15min. Choose the cloud mask product in grb-format. By running \textbf{X - legg inn filnavn} you can generate your own files for regridding. The supplementary material only include the domain used in this thesis, because of GitHub has a maximum limit allowed for uploading. 

\section{AR models}
Can filter pixelwise performance, might me easier to interpret.
% add configuration to the previos theoretical background... 

Lim inn mail fra hugo when appropriate

Variations in experiments 
\begin{enumerate}
    \item Input variables
    \begin{enumerate}
        \item Endrer antall datapunkter som er tilgjengelige
    \end{enumerate}
    \item Test set
\end{enumerate}

\subsection{Performance}



\subsection{Number of samples used in each}
% Move text to discussion.
As a consequence of missing cloud fractional cover values, increasing the order of the AR model, reduces the number samples available for a model. \textbf{Si noe om bedre datagtunnlag veier opp for ett reducert data grunnlag- det gjør det skjeldent for denne type modeller for de }



\subsection{Crossvalidation - best model for three different test sets}
% Prøv å gjøre dette plottet ikke en hel side da er det lettere for latex å plassere det tror jeg.


\section{Conv LSTM}
% Endrer på arkitekturen - denne bruker -train - validation - test, en hvis prosentandel a

batch size = 100
no epochs = 30
learning rate = 0.001
validation split = 0.2

optimizer = 


her er det sånn at du velger en modell du tester på testsettet resten testes på valideringsettet.


